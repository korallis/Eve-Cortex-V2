name: CI/CD Pipeline

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  # Security and Dependency Audit
  security-audit:
    name: Security & Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run security audit
        run: |
          echo "üîç Running security audit..."
          npm audit --audit-level=moderate
          if [ $? -ne 0 ]; then
            echo "‚ùå Security vulnerabilities found!"
            exit 1
          fi

      - name: Check for deprecated dependencies
        run: |
          echo "üîç Checking for deprecated dependencies..."
          npx better-npm-audit audit --level moderate
          if [ $? -ne 0 ]; then
            echo "‚ùå Deprecated or vulnerable dependencies found!"
            exit 1
          fi

      - name: Check for unused dependencies
        run: |
          echo "üîç Checking for unused dependencies..."
          npx depcheck --ignores="@types/*,eslint-config-*,prettier-plugin-*,husky,lint-staged"
          if [ $? -ne 0 ]; then
            echo "‚ö†Ô∏è Unused dependencies found!"
          fi

      - name: Check for outdated dependencies
        run: |
          echo "üîç Checking for outdated dependencies..."
          npx npm-check-updates --errorLevel 2
          if [ $? -ne 0 ]; then
            echo "‚ö†Ô∏è Major version updates available!"
          fi

      - name: Validate package.json
        run: |
          echo "üîç Validating package.json..."
          node -e "
            const pkg = require('./package.json');
            const deps = {...pkg.dependencies, ...pkg.devDependencies};
            
            // Check for deprecated packages
            const deprecatedPackages = [
              'request', 'node-sass', 'gulp', 'bower', 'grunt',
              'babel-core', 'babel-preset-env', 'babel-preset-react',
              'tslint', 'protractor', 'karma', 'phantomjs',
              'node-gyp-build', 'fsevents', 'chokidar'
            ];
            
            const foundDeprecated = Object.keys(deps).filter(dep => 
              deprecatedPackages.some(deprecated => dep.includes(deprecated))
            );
            
            if (foundDeprecated.length > 0) {
              console.error('‚ùå Deprecated packages found:', foundDeprecated);
              process.exit(1);
            }
            
            console.log('‚úÖ No deprecated packages found');
          "

  # Code Quality Checks
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    needs: security-audit
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: |
          echo "üîç Running ESLint..."
          npm run lint
          if [ $? -ne 0 ]; then
            echo "‚ùå ESLint errors found!"
            exit 1
          fi

      - name: Run Prettier check
        run: |
          echo "üîç Checking code formatting..."
          npm run format:check
          if [ $? -ne 0 ]; then
            echo "‚ùå Code formatting issues found!"
            exit 1
          fi

      - name: Run TypeScript check
        run: |
          echo "üîç Running TypeScript check..."
          npm run type-check
          if [ $? -ne 0 ]; then
            echo "‚ùå TypeScript errors found!"
            exit 1
          fi

  # Testing
  test:
    name: Tests
    runs-on: ubuntu-latest
    needs: code-quality
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: eve_cortex_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: |
          echo "üß™ Running tests..."
          npm run test:coverage
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/eve_cortex_test
          REDIS_URL: redis://localhost:6379
          NODE_ENV: test

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

  # Build Test
  build:
    name: Build Test
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: |
          echo "üèóÔ∏è Building application..."
          npm run build
        env:
          NEXTAUTH_URL: http://localhost:3000
          NEXTAUTH_SECRET: test-secret
          EVE_CLIENT_ID: test-client-id
          EVE_CLIENT_SECRET: test-client-secret
          DATABASE_URL: postgresql://test:test@localhost:5432/test
          REDIS_URL: redis://localhost:6379

      - name: Check build output
        run: |
          echo "üîç Checking build output..."
          if [ ! -d ".next" ]; then
            echo "‚ùå Build output directory not found!"
            exit 1
          fi
          
          if [ ! -f ".next/BUILD_ID" ]; then
            echo "‚ùå Build ID file not found!"
            exit 1
          fi
          
          echo "‚úÖ Build completed successfully!"

  # License and Legal Compliance
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    needs: security-audit
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check licenses
        run: |
          echo "üìÑ Checking dependency licenses..."
          npx license-checker --summary --excludePrivatePackages --failOn 'GPL;AGPL;LGPL;UNLICENSED'
          if [ $? -ne 0 ]; then
            echo "‚ùå Incompatible licenses found!"
            exit 1
          fi
          echo "‚úÖ All licenses are compatible!"

  # Auto-merge for dependabot and approved PRs
  auto-merge:
    name: Auto-merge PR
    runs-on: ubuntu-latest
    needs: [security-audit, code-quality, test, build, license-check]
    if: |
      github.event_name == 'pull_request' && 
      (github.actor == 'dependabot[bot]' || 
       github.actor == 'korallis' ||
       contains(github.event.pull_request.labels.*.name, 'auto-merge'))
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Enable auto-merge
        run: |
          echo "ü§ñ Enabling auto-merge for PR #${{ github.event.pull_request.number }}"
          gh pr merge ${{ github.event.pull_request.number }} --auto --squash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add success comment
        if: success()
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "
          ## ‚úÖ All Checks Passed!
          
          - üîí Security audit: **PASSED**
          - üì¶ Dependency check: **PASSED**  
          - üßπ Code quality: **PASSED**
          - üß™ Tests: **PASSED**
          - üèóÔ∏è Build: **PASSED**
          - üìÑ License check: **PASSED**
          
          This PR will be automatically merged.
          "
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add failure comment
        if: failure()
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "
          ## ‚ùå Checks Failed!
          
          This PR cannot be auto-merged due to failing checks. Please review the workflow logs and fix the issues.
          
          Common issues:
          - Security vulnerabilities in dependencies
          - Deprecated packages
          - Code quality issues
          - Test failures
          - Build errors
          - License compliance issues
          "
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Dependency Update Check (runs weekly)
  dependency-update:
    name: Weekly Dependency Update Check
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Check for updates
        run: |
          echo "üîç Checking for dependency updates..."
          npx npm-check-updates --doctor --upgrade
          
          if git diff --quiet package.json; then
            echo "‚úÖ All dependencies are up to date!"
          else
            echo "üì¶ Updates available, creating PR..."
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add package.json package-lock.json
            git commit -m "chore: update dependencies"
            git push origin HEAD:dependency-updates
            
            gh pr create \
              --title "chore: Weekly dependency updates" \
              --body "Automated dependency updates from weekly check" \
              --label "dependencies,auto-merge"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

# Schedule weekly dependency checks
on:
  schedule:
    - cron: '0 9 * * 1' # Every Monday at 9 AM UTC